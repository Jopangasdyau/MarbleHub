local Library = loadstring(game:HttpGetAsync("https://github.com/ActualMasterOogway/Fluent-Renewed/releases/latest/download/Fluent.luau"))()

local Window = Library:CreateWindow{
    Title = `gugu [ beta ]`,
    SubTitle = "V-0.1.1",
    TabWidth = 160,
    Size = UDim2.fromOffset(830, 525),
    Resize = true, -- Resize this ^ Size according to a 1920x1080 screen, good for mobile users but may look weird on some devices
    MinSize = Vector2.new(470, 380),
    Acrylic = true, -- The blur may be detectable, setting this to false disables blur entirely
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl -- Used when theres no MinimizeKeybind
}

local Tabs = {
    Main = Window:CreateTab{
        Title = "esp",
        Icon = "nil"
    }
}

local selectedItem = {}
local espVisuals = {}
local espConnections = {}
local espEnabled = false

local MultiDropdown = Tabs.Main:CreateDropdown("MultiDropdown", {
    Title = "Item",
    Description = "",
    Values = {"Iron Body", "Bandage", "Fuel Canister", "Log", "Medkit", "Forcefield Crystal", "Frog Potion", "Lightning Potion", "Speed Potion", "Sphere of fury", "True Power"},
    Multi = true,
    Default = {},
})

MultiDropdown:OnChanged(function(Value)
    selectedItem = {}
    for ItemName, IsSelected in pairs(Value) do
        if IsSelected then
            table.insert(selectedItem, ItemName)
        end
    end
end)

local Toggle1 = Tabs.Main:CreateToggle("MyToggle", {Title = "esp", Default = false})

-- Full cleanup function
local function removeAllESP()
    -- Destroy everything we tracked
    for _, v in pairs(espVisuals) do
        if v and v.Parent then
            v:Destroy()
        end
    end
    espVisuals = {}

    -- Disconnect all events
    for _, conn in pairs(espConnections) do
        if conn.Connected then
            conn:Disconnect()
        end
    end
    espConnections = {}

    -- Safety wipe: remove ANY leftover ESP objects from items
    local itemsFolder = workspace:FindFirstChild("Items")
    if itemsFolder then
        for _, model in pairs(itemsFolder:GetChildren()) do
            for _, obj in pairs(model:GetChildren()) do
                if obj:IsA("BillboardGui") or obj:IsA("Highlight") or obj:IsA("Attachment") or obj:IsA("Beam") then
                    obj:Destroy()
                end
            end
        end
    end
end

Toggle1:OnChanged(function()
    if not Toggle1Interacted then
        Toggle1Interacted = true
        return
    end

    espEnabled = not espEnabled

    if espEnabled then
        local player = game.Players.LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

        local function highlightModel(model)
            if not model:IsA("Model") then return end

            for _, item in ipairs(selectedItem) do
                if model.Name == item and not model:FindFirstChildOfClass("Highlight") then
                    local highlight = Instance.new("Highlight")
                    highlight.Parent = model
                    highlight.Adornee = model
                    highlight.FillColor = Color3.fromRGB(255, 255, 0)
                    highlight.FillTransparency = 0.4
                    highlight.OutlineColor = Color3.fromRGB(0, 0, 0)
                    highlight.OutlineTransparency = 0.5

                    local billboardGui = Instance.new("BillboardGui")
                    billboardGui.Parent = model
                    billboardGui.Adornee = model
                    billboardGui.Size = UDim2.new(0, 200, 0, 30)
                    billboardGui.StudsOffset = Vector3.new(0, 3, 0)
                    billboardGui.AlwaysOnTop = true

                    local textLabel = Instance.new("TextLabel")
                    textLabel.Parent = billboardGui
                    textLabel.Size = UDim2.new(1, 0, 1, 0)
                    textLabel.BackgroundTransparency = 1
                    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    textLabel.TextSize = 8
                    textLabel.Text = "[" .. model.Name .. " - Distance: --]"

                    local basePart = model:FindFirstChildWhichIsA("BasePart")
                    if not basePart then return end

                    local objectAttachment = Instance.new("Attachment")
                    objectAttachment.Name = "ESPObjectAttachment"
                    objectAttachment.Parent = basePart

                    local playerAttachment = Instance.new("Attachment")
                    playerAttachment.Name = "ESPPlayerAttachment"
                    playerAttachment.Parent = humanoidRootPart

                    local beam = Instance.new("Beam")
                    beam.Attachment0 = objectAttachment
                    beam.Attachment1 = playerAttachment
                    beam.Color = ColorSequence.new(Color3.fromRGB(255, 255, 0))
                    beam.Width0 = 0.1
                    beam.Width1 = 0.1
                    beam.FaceCamera = true
                    beam.LightInfluence = 0
                    beam.Transparency = NumberSequence.new(0.3)
                    beam.Parent = objectAttachment

                    table.insert(espVisuals, highlight)
                    table.insert(espVisuals, billboardGui)
                    table.insert(espVisuals, objectAttachment)
                    table.insert(espVisuals, playerAttachment)
                    table.insert(espVisuals, beam)

                    local heartbeatConn = game:GetService("RunService").Heartbeat:Connect(function()
                        if not espEnabled then return end
                        local distance = (model:GetModelCFrame().Position - humanoidRootPart.Position).Magnitude
                        textLabel.Text = "[" .. model.Name .. " - Distance: " .. math.floor(distance) .. " studs]"
                    end)
                    table.insert(espConnections, heartbeatConn)

                    return
                end
            end
        end

        local itemsFolder = workspace:FindFirstChild("Items")
        if itemsFolder then
            for _, model in pairs(itemsFolder:GetChildren()) do
                highlightModel(model)
            end

            local conn = itemsFolder.ChildAdded:Connect(function(newModel)
                if espEnabled then
                    highlightModel(newModel)
                end
            end)
            table.insert(espConnections, conn)
        end

    else
        removeAllESP()
    end
end)
